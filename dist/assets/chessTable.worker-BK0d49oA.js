(function(){"use strict";const F=f=>String(f??"").trim(),H=f=>(String(f).match(/\d+/)||[])[0]||null,B=f=>String(f).toLowerCase().replace(/ё/g,"е").replace(/[^a-zа-я]/g,""),W=(f,S)=>{if(!f||!S)return!1;const p=String(f).toLowerCase().trim(),r=String(S).toLowerCase().trim();if(B(p)===B(r))return!0;const o=p.split(/\s+/).filter(I=>I.length>0),g=r.split(/\s+/).filter(I=>I.length>0);if(o.length===0||g.length===0)return!1;const x=B(o[0]),N=B(g[0]);if(x!==N)return!1;if(o.length===1&&g.length===1)return!0;const s=o.length>=2?o[1].replace(/\./g,"").trim():"",m=g.length>=2?g[1].trim():"",c=o.length>=3?o[2].replace(/\./g,"").trim():"",y=g.length>=3?g[2].trim():"";let C=!1;s&&m?(s.length===1&&m.length>1||s.length>1&&m.length===1||s[0]===m[0])&&(C=s[0]===m[0]):!s&&!m&&(C=!0);let E=!1;if(c&&y?(c.length===1&&y.length>1||c.length>1&&y.length===1||c[0]===y[0])&&(E=c[0]===y[0]):(!c&&!y||!c&&y||c&&!y)&&(E=!0),C)return c||y?E:!0;if(s&&m&&s[0]===m[0]){if(c&&y&&c[0]===y[0])return!0;if(!c&&!y)return!0}const D=B(p),L=B(r);return!!(D.length>8&&L.length>8&&(D.includes(L)||L.includes(D)))},P=(f,S)=>{if(!f||!S)return!1;const p=String(f).toLowerCase().trim(),r=String(S).toLowerCase().trim(),o=p.replace(/[^a-zа-я0-9]/g,""),g=r.replace(/[^a-zа-я0-9]/g,"");if(o===g||o.length>3&&g.length>3&&(o.includes(g)||g.includes(o)))return!0;const x=p.match(/\d+/g),N=r.match(/\d+/g);return x&&N?x.some(s=>N.includes(s)):!1},z=(f,S,p)=>{if(!p||!p[f])return{available:!0};const r=p[f].status;if(!r)return{available:!0};const[o,g,x]=S.split(".").map(Number),N=new Date(x,g-1,o),s=r;if(s.permanent)return{available:!1,reason:s.raw,type:s.type};if(s.from&&s.to){N.setHours(0,0,0,0);const m=new Date(s.from);m.setHours(0,0,0,0);const c=new Date(s.to);if(c.setHours(0,0,0,0),N>=m&&N<=c)return{available:!1,reason:s.raw,type:s.type}}return{available:!0}},_=f=>{const S=String(f||"").trim().split(/\s+/)[0]||"";return B(S)};function R(f){const S=Array.isArray(f==null?void 0:f[0])?f[0]:[],p=new Map;return(f||[]).slice(1).forEach(r=>{let o=r==null?void 0:r[11],g="";if(o instanceof Date)g=o.toLocaleDateString("ru-RU");else if(typeof o=="string"){const c=new Date(o);isNaN(c.getTime())?g=F(o):g=c.toLocaleDateString("ru-RU")}if(!g||g.length<5)return;const x=F(r==null?void 0:r[13]),N=F(r==null?void 0:r[14]),s=H(N);if(!s)return;p.has(g)||p.set(g,{});const m=p.get(g);m[s]||(m[s]={id:s,name:N,type:x,activeLines:[]});for(let c=15;c<=26;c++){const y=F(S==null?void 0:S[c]);y&&(parseInt(r==null?void 0:r[c])||0)>0&&!m[s].activeLines.includes(y)&&m[s].activeLines.push(y)}}),{headers:S,brigadesByDate:p}}function V({targetDate:f,brigadesMap:S,lineTemplates:p,floaters:r,manualAssignments:o,workerRegistry:g,availabilityCache:x}){if(!S)return[];const N=s=>{const m=`${s}|${f}`;if(x.has(m))return x.get(m);const c=z(s,f,g);return x.set(m,c),c};return Object.values(S).map(s=>{const m=s.type?String(s.type).toLowerCase():"",c=[],y=[],C=new Map,E=new Map;Object.keys(p||{}).forEach(b=>{(p[b]||[]).forEach(h=>{var a;const e=(a=h==null?void 0:h.roster)==null?void 0:a[s.id];e&&String(e).split(/[,;\n/]+/).map(t=>t.trim()).filter(t=>t.length>1).forEach(t=>{const d=N(t),n={name:t,role:h.role,homeLine:b,id:`${t}_${s.id}`,isBusy:!1,isAvailable:d.available,statusReason:d.reason};y.push(n),C.set(n.id,n),E.set(`${B(t)}|${b}`,n)})})});const D=new Set;Object.keys(o||{}).forEach(b=>{if(b.startsWith(f)){const h=o[b];(h==null?void 0:h.type)!=="vacancy"&&D.add(h.originalId||h.id)}}),(s.activeLines||[]).forEach(b=>{const h=Object.keys(p||{}).find(t=>P(b,t)),e=h?p[h]:[],a=[];e.length>0&&e.forEach(t=>{var i,w;const d=(i=t==null?void 0:t.roster)==null?void 0:i[s.id],n=d?String(d).split(/[,;\n/]+/).map(u=>u.trim()).filter(u=>u.length>1):[],l=Math.max(t.count,n.length);for(let u=0;u<l;u++){const M=`${f}_${s.id}_${b}_${t.role}_${u}`,v=n[u]||null;let k="vacancy";v&&(k=N(v).available?"filled":"vacancy");const $=o==null?void 0:o[M];if($&&(k=$.type==="vacancy"?"vacancy":"manual"),k==="filled"&&v&&(N(v).available||(k="vacancy")),a.push({status:k,roleTitle:t.role,slotId:M,isManualVacancy:((w=o==null?void 0:o[M])==null?void 0:w.type)==="vacancy",currentWorkerName:v,assigned:$||(k==="filled"?{name:v}:null)}),$&&$.type!=="vacancy"&&$.type!=="floater"){const O=C.get($.originalId||$.id);O&&(O.isBusy=!0)}else if(!$&&k==="filled"&&v){const O=E.get(`${B(v)}|${h||""}`);O&&(O.isBusy=!0)}}}),c.push({slots:a,displayName:h||b})});const L=y.filter(b=>!b.isBusy&&b.isAvailable);c.forEach(b=>{b.slots.forEach(h=>{if(h.status==="vacancy"&&!h.isManualVacancy&&L.length>0){let e=L.findIndex(a=>a.role===h.roleTitle);e===-1&&(e=L.findIndex(a=>{var d;const t=g==null?void 0:g[a.name];return t&&((d=t.competencies)==null?void 0:d.has)&&t.competencies.has(h.roleTitle)})),e>=0&&(h.status="reassigned",h.assigned=L[e],L[e].isBusy=!0,L.splice(e,1))}})});const T=(m.includes("день")?[...(r==null?void 0:r.day)||[]]:[...(r==null?void 0:r.night)||[]]).filter(b=>!D.has(b.id)),j=c.reduce((b,h)=>b+h.slots.length,0),A=c.reduce((b,h)=>b+h.slots.filter(e=>e.status!=="vacancy"&&e.status!=="unknown").length,0);return{id:s.id,name:s.name,type:s.type,lineTasks:c,unassignedPeople:y.filter(b=>!b.isBusy),floaters:T,totalRequired:j,filledSlots:A}})}function q(f){const{scheduleDates:S,demand:p,lineTemplates:r,floaters:o,manualAssignments:g,workerRegistry:x,factData:N}=f,s=Array.isArray(S)?S:[];if(!p||s.length===0)return null;const m={};Object.entries(x||{}).forEach(([e,a])=>{m[e]={...a,competencies:new Set((a==null?void 0:a.competencies)||[])}});const c=R(p),y=new Map,C=new Map;s.forEach(e=>{C.set(e,V({targetDate:e,brigadesMap:c.brigadesByDate.get(e),lineTemplates:r,floaters:o,manualAssignments:g,workerRegistry:m,availabilityCache:y}))});const E=new Map;Object.keys(r||{}).forEach(e=>{(r[e]||[]).forEach(a=>{const t=(a==null?void 0:a.roster)||{};Object.entries(t).forEach(([d,n])=>{n&&String(n).split(/[,;\n/]+/).map(l=>l.trim()).filter(l=>l.length>1).forEach(l=>{E.has(l)||E.set(l,{name:l,role:a.role,homeLine:e,homeBrigades:new Set,category:"staff",sortShift:99});const i=E.get(l);i.homeBrigades.add(d),i.sortShift=Math.min(i.sortShift,parseInt(d)||99)})})})}),((o==null?void 0:o.day)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Д",homeBrigades:new Set,category:"floater_day",sortShift:100}))}),((o==null?void 0:o.night)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Н",homeBrigades:new Set,category:"floater_night",sortShift:101}))});const D=Array.from(E.values()).sort((e,a)=>(e.category==="staff"?e.sortShift-a.sortShift:10)||e.name.localeCompare(a.name)),L=new Map,I=new Map;D.forEach(e=>{const a=B(e.name);L.set(a,e);const t=_(e.name);I.has(t)||I.set(t,[]),I.get(t).push(e)});const T=new Map,j=new Map;N&&Object.entries(N).forEach(([e,a])=>{const t=new Map,d=new Map;Object.values(a||{}).forEach(n=>{if(!n)return;const l=n.rawName||"",i=B(l);i&&t.set(i,n);const w=_(l);d.has(w)||d.set(w,[]),d.get(w).push(n)}),T.set(e,t),j.set(e,d)});const A=(e,a)=>{const t=T.get(e);if(!t)return null;const d=B(a),n=t.get(d);if(n)return n;const l=_(a),i=j.get(e),w=(i==null?void 0:i.get(l))||[];for(const u of w)if(u!=null&&u.rawName&&W(a,u.rawName))return u;return null};if(N){const e=new Map;s.forEach(a=>{const t=j.get(a);t&&t.forEach(d=>{d.forEach(n=>{if(!(n!=null&&n.rawName)||!n.cleanTime&&!n.nextDayExit)return;const l=B(n.rawName);if(L.has(l))return;const i=_(n.rawName),w=I.get(i)||[];let u=!1;for(const M of w)if(W(M.name,n.rawName)){u=!0;break}if(!u&&!e.has(l)){const M=(x==null?void 0:x[n.rawName])||null;e.set(l,{name:n.rawName,role:(M==null?void 0:M.role)||"Неизвестно",homeLine:"Вне плана",homeBrigades:new Set,category:"unexpected",sortShift:102,cells:{}})}})})}),e.size>0&&(e.forEach(a=>D.push(a)),D.sort((a,t)=>(a.category==="staff"?a.sortShift-t.sortShift:10)||a.name.localeCompare(t.name)))}D.forEach(e=>{e.cells={}});const b=(e,a)=>{const t=`${e}|${a}`;if(y.has(t))return y.get(t);const d=z(e,a,m);return y.set(t,d),d};s.forEach(e=>{const a=C.get(e)||[],t=new Map,d=new Map;a.forEach(n=>{const i=String(n.type||"").toLowerCase().includes("ночь")?"Н":"Д";n.lineTasks.forEach(w=>{w.slots.forEach(u=>{if((u.status==="filled"||u.status==="manual"||u.status==="reassigned")&&u.assigned){const M=u.assigned.name;if(u.assigned.type==="external")t.set(M,{code:"РВ",brigadeId:n.id,isRv:!0});else{const v=t.get(M),k=v&&v.code!==i&&!v.isRv?"Д/Н":i;t.set(M,{code:k,brigadeId:n.id})}}})}),n.unassignedPeople.forEach(w=>{w.isAvailable&&d.set(w.name,n.id)}),n.floaters.forEach(w=>d.set(w.name,n.id))}),D.forEach(n=>{let l="",i="bg-white",w=null,u=null;const M=b(n.name,e);if(!M.available)M.type==="vacation"?(l="О",i="bg-emerald-50 text-emerald-700 border-emerald-200"):M.type==="sick"?(l="Б",i="bg-amber-50 text-amber-700 border-amber-200"):M.type==="fired"&&(l="У",i="bg-slate-200 text-slate-500");else if(t.has(n.name)){const v=t.get(n.name);l=v.code,w=v.brigadeId,l==="Д"?i="bg-green-100 text-green-800 border-green-200 font-bold":l==="Н"?i="bg-blue-100 text-blue-800 border-blue-200 font-bold":l==="Д/Н"?i="bg-teal-100 text-teal-800 border-teal-200 font-bold":l==="РВ"&&(i="bg-orange-100 text-orange-700 border-orange-200 font-bold");const k=A(e,n.name);k&&(k.cleanTime||k.nextDayExit?(u="ok",i.includes("ring-")||(i=i.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-green-500")):(u="missing",i.includes("ring-")||(i=i.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")))}else if(d.has(n.name)){l="—",i="bg-yellow-100 text-yellow-800 border-yellow-200 font-bold",w=d.get(n.name);const v=A(e,n.name);v&&(v.cleanTime||v.nextDayExit?u="unassigned":(u="missing",i.includes("ring-")||(i=i.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")))}else{const v=A(e,n.name);v&&(v.cleanTime||v.nextDayExit)&&(u="unexpected",l="!",i="bg-orange-50 text-orange-700 border-orange-200 font-bold")}n.cells[e]={text:l,color:i,brigadeId:w,verificationStatus:u}})});const h=D.map(e=>({...e,homeBrigades:Array.from(e.homeBrigades||[])}));return{dates:s,workers:h}}self.onmessage=f=>{const{requestId:S,payload:p}=f.data||{};try{const r=q(p);self.postMessage({requestId:S,result:r})}catch(r){self.postMessage({requestId:S,error:(r==null?void 0:r.message)||String(r)})}}})();
