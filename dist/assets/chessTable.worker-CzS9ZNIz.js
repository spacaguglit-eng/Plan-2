(function(){"use strict";const _=g=>String(g??"").trim(),R=g=>(String(g).match(/\d+/)||[])[0]||null,x=g=>String(g).toLowerCase().replace(/ё/g,"е").replace(/[^a-zа-я]/g,""),z=(g,S)=>{if(!g||!S)return!1;const y=String(g).toLowerCase().trim(),a=String(S).toLowerCase().trim();if(x(y)===x(a))return!0;const i=y.split(/\s+/).filter(k=>k.length>0),d=a.split(/\s+/).filter(k=>k.length>0);if(i.length===0||d.length===0)return!1;const M=x(i[0]),B=x(d[0]);if(M!==B)return!1;if(i.length===1&&d.length===1)return!0;const c=i.length>=2?i[1].replace(/\./g,"").trim():"",o=d.length>=2?d[1].trim():"",l=i.length>=3?i[2].replace(/\./g,"").trim():"",p=d.length>=3?d[2].trim():"";let D=!1;c&&o?(c.length===1&&o.length>1||c.length>1&&o.length===1||c[0]===o[0])&&(D=c[0]===o[0]):!c&&!o&&(D=!0);let I=!1;if(l&&p?(l.length===1&&p.length>1||l.length>1&&p.length===1||l[0]===p[0])&&(I=l[0]===p[0]):(!l&&!p||!l&&p||l&&!p)&&(I=!0),D)return l||p?I:!0;if(c&&o&&c[0]===o[0]){if(l&&p&&l[0]===p[0])return!0;if(!l&&!p)return!0}const E=x(y),L=x(a);return!!(E.length>8&&L.length>8&&(E.includes(L)||L.includes(E)))},P=(g,S)=>{if(!g||!S)return!1;const y=String(g).toLowerCase().trim(),a=String(S).toLowerCase().trim(),i=y.replace(/[^a-zа-я0-9]/g,""),d=a.replace(/[^a-zа-я0-9]/g,"");if(i===d||i.length>3&&d.length>3&&(i.includes(d)||d.includes(i)))return!0;const M=y.match(/\d+/g),B=a.match(/\d+/g);return M&&B?M.some(c=>B.includes(c)):!1},H=(g,S,y)=>{if(!y||!y[g])return{available:!0};const a=y[g].status;if(!a)return{available:!0};const[i,d,M]=S.split(".").map(Number),B=new Date(M,d-1,i),c=a;if(c.permanent)return{available:!1,reason:c.raw,type:c.type};if(c.from&&c.to){B.setHours(0,0,0,0);const o=new Date(c.from);o.setHours(0,0,0,0);const l=new Date(c.to);if(l.setHours(0,0,0,0),B>=o&&B<=l)return{available:!1,reason:c.raw,type:c.type}}return{available:!0}},T=g=>{const S=String(g||"").trim().split(/\s+/)[0]||"";return x(S)};function V(g){const S=Array.isArray(g==null?void 0:g[0])?g[0]:[],y=new Map;return(g||[]).slice(1).forEach(a=>{let i=a==null?void 0:a[11],d="";if(i instanceof Date)d=i.toLocaleDateString("ru-RU");else if(typeof i=="string"){const l=new Date(i);isNaN(l.getTime())?d=_(i):d=l.toLocaleDateString("ru-RU")}if(!d||d.length<5)return;const M=_(a==null?void 0:a[13]),B=_(a==null?void 0:a[14]),c=R(B);if(!c)return;y.has(d)||y.set(d,{});const o=y.get(d);o[c]||(o[c]={id:c,name:B,type:M,activeLines:[]});for(let l=15;l<=26;l++){const p=_(S==null?void 0:S[l]);p&&(parseInt(a==null?void 0:a[l])||0)>0&&!o[c].activeLines.includes(p)&&o[c].activeLines.push(p)}}),{headers:S,brigadesByDate:y}}function q({targetDate:g,brigadesMap:S,lineTemplates:y,floaters:a,manualAssignments:i,workerRegistry:d,availabilityCache:M,autoReassignEnabled:B}){if(!S)return[];const c=o=>{const l=`${o}|${g}`;if(M.has(l))return M.get(l);const p=H(o,g,d);return M.set(l,p),p};return Object.values(S).map(o=>{const l=o.type?String(o.type).toLowerCase():"",p=[],D=[],I=new Map,E=new Map;Object.keys(y||{}).forEach(b=>{(y[b]||[]).forEach(h=>{var s;const e=(s=h==null?void 0:h.roster)==null?void 0:s[o.id];e&&String(e).split(/[,;\n/]+/).map(t=>t.trim()).filter(t=>t.length>1).forEach(t=>{const m=c(t),n={name:t,role:h.role,homeLine:b,id:`${t}_${o.id}`,isBusy:!1,isAvailable:m.available,statusReason:m.reason};D.push(n),I.set(n.id,n),E.set(`${x(t)}|${b}`,n)})})});const L=new Set;Object.keys(i||{}).forEach(b=>{if(b.startsWith(g)){const h=i[b];(h==null?void 0:h.type)!=="vacancy"&&L.add(h.originalId||h.id)}}),(o.activeLines||[]).forEach(b=>{const h=Object.keys(y||{}).find(t=>P(b,t)),e=h?y[h]:[],s=[];e.length>0&&e.forEach(t=>{var r,v;const m=(r=t==null?void 0:t.roster)==null?void 0:r[o.id],n=m?String(m).split(/[,;\n/]+/).map(u=>u.trim()).filter(u=>u.length>1):[],f=Math.max(t.count,n.length);for(let u=0;u<f;u++){const N=`${g}_${o.id}_${b}_${t.role}_${u}`,w=n[u]||null;let C="vacancy";w&&(C=c(w).available?"filled":"vacancy");const $=i==null?void 0:i[N];if($&&(C=$.type==="vacancy"?"vacancy":"manual"),C==="filled"&&w&&(c(w).available||(C="vacancy")),s.push({status:C,roleTitle:t.role,slotId:N,isManualVacancy:((v=i==null?void 0:i[N])==null?void 0:v.type)==="vacancy",currentWorkerName:w,assigned:$||(C==="filled"?{name:w}:null)}),$&&$.type!=="vacancy"&&$.type!=="floater"){const O=I.get($.originalId||$.id);O&&(O.isBusy=!0)}else if(!$&&C==="filled"&&w){const O=E.get(`${x(w)}|${h||""}`);O&&(O.isBusy=!0)}}}),p.push({slots:s,displayName:h||b})});const k=D.filter(b=>!b.isBusy&&b.isAvailable);B&&p.forEach(b=>{b.slots.forEach(h=>{if(h.status==="vacancy"&&!h.isManualVacancy&&k.length>0){let e=k.findIndex(s=>s.role===h.roleTitle);e===-1&&(e=k.findIndex(s=>{var m;const t=d==null?void 0:d[s.name];return t&&((m=t.competencies)==null?void 0:m.has)&&t.competencies.has(h.roleTitle)})),e>=0&&(h.status="reassigned",h.assigned=k[e],k[e].isBusy=!0,k.splice(e,1))}})});const W=(l.includes("день")?[...(a==null?void 0:a.day)||[]]:[...(a==null?void 0:a.night)||[]]).filter(b=>!L.has(b.id)),A=p.reduce((b,h)=>b+h.slots.length,0),F=p.reduce((b,h)=>b+h.slots.filter(e=>e.status!=="vacancy"&&e.status!=="unknown").length,0);return{id:o.id,name:o.name,type:o.type,lineTasks:p,unassignedPeople:D.filter(b=>!b.isBusy),floaters:W,totalRequired:A,filledSlots:F}})}function U(g){const{scheduleDates:S,demand:y,lineTemplates:a,floaters:i,manualAssignments:d,workerRegistry:M,factData:B,autoReassignEnabled:c}=g,o=Array.isArray(S)?S:[];if(!y||o.length===0)return null;const l={};Object.entries(M||{}).forEach(([e,s])=>{l[e]={...s,competencies:new Set((s==null?void 0:s.competencies)||[])}});const p=V(y),D=new Map,I=new Map;o.forEach(e=>{I.set(e,q({targetDate:e,brigadesMap:p.brigadesByDate.get(e),lineTemplates:a,floaters:i,manualAssignments:d,workerRegistry:l,availabilityCache:D,autoReassignEnabled:c}))});const E=new Map;Object.keys(a||{}).forEach(e=>{(a[e]||[]).forEach(s=>{const t=(s==null?void 0:s.roster)||{};Object.entries(t).forEach(([m,n])=>{n&&String(n).split(/[,;\n/]+/).map(f=>f.trim()).filter(f=>f.length>1).forEach(f=>{E.has(f)||E.set(f,{name:f,role:s.role,homeLine:e,homeBrigades:new Set,category:"staff",sortShift:99});const r=E.get(f);r.homeBrigades.add(m),r.sortShift=Math.min(r.sortShift,parseInt(m)||99)})})})}),((i==null?void 0:i.day)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Д",homeBrigades:new Set,category:"floater_day",sortShift:100}))}),((i==null?void 0:i.night)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Н",homeBrigades:new Set,category:"floater_night",sortShift:101}))});const L=Array.from(E.values()).sort((e,s)=>(e.category==="staff"?e.sortShift-s.sortShift:10)||e.name.localeCompare(s.name)),k=new Map,j=new Map;L.forEach(e=>{const s=x(e.name);k.set(s,e);const t=T(e.name);j.has(t)||j.set(t,[]),j.get(t).push(e)});const W=new Map,A=new Map;B&&Object.entries(B).forEach(([e,s])=>{const t=new Map,m=new Map;Object.values(s||{}).forEach(n=>{if(!n)return;const f=n.rawName||"",r=x(f);r&&t.set(r,n);const v=T(f);m.has(v)||m.set(v,[]),m.get(v).push(n)}),W.set(e,t),A.set(e,m)});const F=(e,s)=>{const t=W.get(e);if(!t)return null;const m=x(s),n=t.get(m);if(n)return n;const f=T(s),r=A.get(e),v=(r==null?void 0:r.get(f))||[];for(const u of v)if(u!=null&&u.rawName&&z(s,u.rawName))return u;return null};if(B){const e=new Map;o.forEach(s=>{const t=A.get(s);t&&t.forEach(m=>{m.forEach(n=>{if(!(n!=null&&n.rawName)||!n.cleanTime)return;const f=x(n.rawName);if(k.has(f))return;const r=T(n.rawName),v=j.get(r)||[];let u=!1;for(const N of v)if(z(N.name,n.rawName)){u=!0;break}if(!u&&!e.has(f)){const N=(M==null?void 0:M[n.rawName])||null;e.set(f,{name:n.rawName,role:(N==null?void 0:N.role)||"Неизвестно",homeLine:"Вне плана",homeBrigades:new Set,category:"unexpected",sortShift:102,cells:{}})}})})}),e.size>0&&(e.forEach(s=>L.push(s)),L.sort((s,t)=>(s.category==="staff"?s.sortShift-t.sortShift:10)||s.name.localeCompare(t.name)))}L.forEach(e=>{e.cells={}});const b=(e,s)=>{const t=`${e}|${s}`;if(D.has(t))return D.get(t);const m=H(e,s,l);return D.set(t,m),m};o.forEach(e=>{const s=I.get(e)||[],t=new Map,m=new Map;s.forEach(n=>{const r=String(n.type||"").toLowerCase().includes("ночь")?"Н":"Д";n.lineTasks.forEach(v=>{v.slots.forEach(u=>{if((u.status==="filled"||u.status==="manual"||u.status==="reassigned")&&u.assigned){const N=u.assigned.name;if(u.assigned.type==="external")t.set(N,{code:"РВ",brigadeId:n.id,isRv:!0});else{const w=t.get(N),C=w&&w.code!==r&&!w.isRv?"Д/Н":r;t.set(N,{code:C,brigadeId:n.id})}}})}),n.unassignedPeople.forEach(v=>{v.isAvailable&&m.set(v.name,n.id)}),n.floaters.forEach(v=>m.set(v.name,n.id))}),L.forEach(n=>{let f="",r="bg-white",v=null,u=null;const N=b(n.name,e);if(!N.available)N.type==="vacation"?(f="О",r="bg-emerald-50 text-emerald-700 border-emerald-200"):N.type==="sick"?(f="Б",r="bg-amber-50 text-amber-700 border-amber-200"):N.type==="fired"&&(f="У",r="bg-slate-200 text-slate-500");else if(t.has(n.name)){const w=t.get(n.name);f=w.code,v=w.brigadeId,f==="Д"?r="bg-green-100 text-green-800 border-green-200 font-bold":f==="Н"?r="bg-blue-100 text-blue-800 border-blue-200 font-bold":f==="Д/Н"?r="bg-teal-100 text-teal-800 border-teal-200 font-bold":f==="РВ"&&(r="bg-orange-100 text-orange-700 border-orange-200 font-bold");const C=F(e,n.name);C?C.cleanTime?(u="ok",r.includes("ring-")||(r=r.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-green-500")):(u="missing",r.includes("ring-")||(r=r.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")):(u="missing",r.includes("ring-")||(r=r.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500"))}else if(m.has(n.name)){f="—",r="bg-yellow-100 text-yellow-800 border-yellow-200 font-bold",v=m.get(n.name);const w=F(e,n.name);w&&(w.cleanTime?u="unassigned":(u="missing",r.includes("ring-")||(r=r.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")))}else{const w=F(e,n.name);w&&w.cleanTime&&(u="unexpected",f="!",r="bg-orange-50 text-orange-700 border-orange-200 font-bold")}n.cells[e]={text:f,color:r,brigadeId:v,verificationStatus:u}})});const h=L.map(e=>({...e,homeBrigades:Array.from(e.homeBrigades||[])}));return{dates:o,workers:h}}self.onmessage=g=>{const{requestId:S,payload:y}=g.data||{};try{const a=U(y);self.postMessage({requestId:S,result:a})}catch(a){self.postMessage({requestId:S,error:(a==null?void 0:a.message)||String(a)})}}})();
