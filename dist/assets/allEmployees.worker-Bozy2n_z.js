(function(){"use strict";const I=t=>String(t).toLowerCase().replace(/ё/g,"е").replace(/[^a-zа-я]/g,""),A=(t,n)=>{if(!t||!n)return!1;const c=String(t).toLowerCase().trim(),m=String(n).toLowerCase().trim();if(I(c)===I(m))return!0;const f=c.split(/\s+/).filter(h=>h.length>0),a=m.split(/\s+/).filter(h=>h.length>0);if(f.length===0||a.length===0)return!1;const p=I(f[0]),d=I(a[0]);if(p!==d)return!1;if(f.length===1&&a.length===1)return!0;const r=f.length>=2?f[1].replace(/\./g,"").trim():"",s=a.length>=2?a[1].trim():"",i=f.length>=3?f[2].replace(/\./g,"").trim():"",o=a.length>=3?a[2].trim():"";let v=!1;r&&s?(r.length===1&&s.length>1||r.length>1&&s.length===1||r[0]===s[0])&&(v=r[0]===s[0]):!r&&!s&&(v=!0);let g=!1;if(i&&o?(i.length===1&&o.length>1||i.length>1&&o.length===1||i[0]===o[0])&&(g=i[0]===o[0]):(!i&&!o||!i&&o||i&&!o)&&(g=!0),v)return i||o?g:!0;if(r&&s&&r[0]===s[0]&&(i&&o&&i[0]===o[0]||!i&&!o))return!0;const u=I(c),l=I(m);return!!(u.length>8&&l.length>8&&(u.includes(l)||l.includes(u)))},k=t=>String(t??"").trim(),z=t=>(String(t).match(/\d+/)||[])[0]||null,_=(t,n)=>{if(!t||!n)return!1;const c=String(t).toLowerCase().trim(),m=String(n).toLowerCase().trim(),f=c.replace(/[^a-zа-я0-9]/g,""),a=m.replace(/[^a-zа-я0-9]/g,"");if(f===a||f.length>3&&a.length>3&&(f.includes(a)||a.includes(f)))return!0;const p=c.match(/\d+/g),d=m.match(/\d+/g);return p&&d?p.some(r=>d.includes(r)):!1},E=(t,n)=>{if(!t||!n)return null;const c=r=>{const s=String(r).match(/(\d{1,2}):(\d{2})/);if(!s)return null;const i=parseInt(s[1],10),o=parseInt(s[2],10);return i*60+o},m=c(t),f=c(n);if(m===null||f===null)return null;let a=f-m;a<0&&(a+=1440);const p=Math.floor(a/60),d=a%60;return{hours:p,minutes:d,totalMinutes:a}},O=t=>t?t.cleanTime||t.entryTime&&t.exitTime?"ok":t.entryTime&&!t.exitTime||!t.entryTime&&t.exitTime?"incomplete":"missing":"missing",W=(t,n)=>{if(!t||!t.data)return[];const{rawTables:c,lineTemplates:m,manualAssignments:f}=t.data;if(!(c!=null&&c.demand)||!Array.isArray(c.demand))return[];const a=c.demand,p=Array.isArray(a[0])?a[0]:[],d={};a.slice(1).forEach(s=>{if(!s)return;let i=s[11],o="";if(i instanceof Date)o=i.toLocaleDateString("ru-RU");else if(typeof i=="string"){const l=new Date(i);isNaN(l.getTime())?o=k(i):o=l.toLocaleDateString("ru-RU")}if(o!==n)return;const v=k(s[13]),g=k(s[14]),u=z(g);if(u){d[u]||(d[u]={id:u,name:g,type:v,activeLines:[]});for(let l=15;l<=26;l++){const h=k(p[l]);h&&(parseInt(s[l],10)||0)>0&&!d[u].activeLines.includes(h)&&d[u].activeLines.push(h)}}});const r=[];return Object.values(d).forEach(s=>{const i=[];s.activeLines.forEach(o=>{const v=Object.keys(m||{}).find(l=>_(o,l)),g=v?m[v]||[]:[],u=[];g.forEach(l=>{var T;const h=(T=l==null?void 0:l.roster)==null?void 0:T[s.id],N=h?h.split(/[,;\n/]+/).map(C=>C.trim()).filter(C=>C.length>1):[],S=Math.max(l.count||1,N.length);for(let C=0;C<S;C++){const M=`${n}_${s.id}_${o}_${l.role}_${C}`,j=N[C]||null,e=f==null?void 0:f[M];let w=j?"filled":"vacancy";e&&(w=e.type==="vacancy"?"vacancy":"manual"),u.push({status:w,roleTitle:l.role,slotId:M,currentWorkerName:j,assigned:e||(w==="filled"?{name:j}:null)})}}),u.length>0&&i.push({slots:u,displayName:v||o})}),i.length>0&&r.push({id:s.id,name:s.name,type:s.type,lineTasks:i})}),r},H=(t,n)=>!t.events||t.events.length===0?!1:t.events.some(c=>c.planInfo&&c.planInfo.shiftId===n),U=t=>!t.events||t.events.length===0?!1:t.events.some(n=>n.factInfo!==null),F=(t,n)=>{if(!n)return!0;const c=n.toLowerCase();return t.name.toLowerCase().includes(c)||t.role.toLowerCase().includes(c)||t.department.toLowerCase().includes(c)},x=(t,n)=>n==="all"?!0:t.role===n,b=(t,n)=>n==="all"?!0:H(t,n),L=(t,n)=>{if(n==="all")return!0;switch(n){case"errors":return t.errorCount>0;case"rv":return t.rvCount>0;case"working":return t.shiftsCount>0;case"idle":return t.shiftsCount===0&&!U(t);default:return!0}},y=({workerRegistry:t,factData:n,savedPlans:c,allEmployees:m})=>{const f=c==null?void 0:c.find(r=>r.type==="Operational"),a=new Map;if((t||[]).forEach(r=>{var i;if(!r||!r.name)return;const s=I(r.name);a.set(s,{name:r.name,role:r.role||"Не указано",department:((i=m==null?void 0:m[s])==null?void 0:i.department)||"",shiftsCount:0,rvCount:0,errorCount:0,hoursTotal:0,events:[]})}),n&&typeof n=="object"&&Object.keys(n).length>0&&Object.values(n).forEach(r=>{!r||typeof r!="object"||Object.values(r).forEach(s=>{var i;if(s&&s.rawName){const o=I(s.rawName);a.has(o)||a.set(o,{name:s.rawName,role:"Не указано",department:((i=m==null?void 0:m[o])==null?void 0:i.department)||"",shiftsCount:0,rvCount:0,errorCount:0,hoursTotal:0,events:[]})}})}),!(f!=null&&f.data))return n&&typeof n=="object"&&Object.keys(n).length>0&&a.forEach((r,s)=>{const i=[];let o=0,v=0;Object.keys(n).sort().forEach(g=>{var N;let u=(N=n[g])==null?void 0:N[s];!u&&n[g]&&Object.values(n[g]).forEach(S=>{S&&S.rawName&&A(S.rawName,r.name)&&(u=S)});const l=O(u);l==="incomplete"&&o++;let h=null;if(u){const S=u.exitTime;u.entryTime&&S&&(h=E(u.entryTime,S),h&&(v+=h.totalMinutes))}i.push({date:g,planInfo:null,factInfo:u||null,duration:h,status:l})}),r.errorCount=o,r.hoursTotal=v,r.events=i}),Array.from(a.values());const p=f.data.scheduleDates||[],d={};return p.forEach(r=>{d[r]=W(f,r)}),a.forEach((r,s)=>{const i=[];let o=0,v=0,g=0,u=0;p.forEach(l=>{var j;const h=d[l]||[];let N=!1,S=null;h.forEach(e=>{e.lineTasks.forEach(w=>{w.slots.forEach(R=>{if((R.status==="filled"||R.status==="manual"||R.status==="reassigned")&&R.assigned){const B=R.assigned.name;if(I(B)===s||A(B,r.name)){N=!0;const $=R.assigned.type==="external";$?v++:o++,S={shiftId:e.id,shiftName:e.name,lineName:w.displayName,role:R.roleTitle,isRv:$}}}})})});let T=(j=n==null?void 0:n[l])==null?void 0:j[s];if(!T&&(n!=null&&n[l])){const e=n[l];Object.values(e).forEach(w=>{w&&w.rawName&&A(w.rawName,r.name)&&(T=w)})}const C=O(T);C==="incomplete"&&g++;let M=null;if(T){const e=T.exitTime;T.entryTime&&e&&(M=E(T.entryTime,e),M&&(u+=M.totalMinutes))}i.push({date:l,planInfo:N?S:null,factInfo:T||null,duration:M,status:C})}),r.shiftsCount=o,r.rvCount=v,r.errorCount=g,r.hoursTotal=u,r.events=i.sort((l,h)=>{const[N,S]=l.date.split("."),[T,C]=h.date.split(".");return new Date(2024,parseInt(S,10)-1,parseInt(N,10))-new Date(2024,parseInt(C,10)-1,parseInt(T,10))})}),Array.from(a.values())};self.onmessage=t=>{const{requestId:n,payload:c}=t.data||{};if(!c)return;const{workerRegistry:m,factData:f,savedPlans:a,allEmployees:p,search:d,filterRole:r,filterBrigade:s,filterStatus:i}=c,o=y({workerRegistry:m,factData:f,savedPlans:a,allEmployees:p}),v=new Set;o.forEach(e=>{e.role&&e.role!=="Не указано"&&v.add(e.role)});const g=Array.from(v).sort(),u={},l={1:0,2:0,3:0,4:0},h={errors:0,rv:0,working:0,idle:0},N=o.filter(e=>F(e,d));N.filter(e=>b(e,s)&&L(e,i)).forEach(e=>{e.role&&e.role!=="Не указано"&&(u[e.role]=(u[e.role]||0)+1)});const T=N.filter(e=>x(e,r)&&L(e,i));["1","2","3","4"].forEach(e=>{l[e]=T.filter(w=>b(w,e)).length});const C=N.filter(e=>x(e,r)&&b(e,s));h.errors=C.filter(e=>L(e,"errors")).length,h.rv=C.filter(e=>L(e,"rv")).length,h.working=C.filter(e=>L(e,"working")).length,h.idle=C.filter(e=>L(e,"idle")).length;const M=N.filter(e=>x(e,r)&&b(e,s)&&L(e,i)).length,j=o.filter(e=>F(e,d)&&x(e,r)&&b(e,s)&&L(e,i));self.postMessage({requestId:n,result:{employeesWithStats:o,allRoles:g,filterCounts:{roles:u,brigades:l,statuses:h,total:M},filteredEmployees:j}})}})();
