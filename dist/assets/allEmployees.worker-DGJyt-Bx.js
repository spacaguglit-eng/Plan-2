(function(){"use strict";const y=s=>String(s).toLowerCase().replace(/ё/g,"е").replace(/[^a-zа-я]/g,""),O=(s,o)=>{if(!s||!o)return!1;const r=String(s).toLowerCase().trim(),l=String(o).toLowerCase().trim();if(y(r)===y(l))return!0;const u=r.split(/\s+/).filter(T=>T.length>0),e=l.split(/\s+/).filter(T=>T.length>0);if(u.length===0||e.length===0)return!1;const m=y(u[0]),i=y(e[0]);if(m!==i)return!1;if(u.length===1&&e.length===1)return!0;const f=u.length>=2?u[1].replace(/\./g,"").trim():"",a=e.length>=2?e[1].trim():"",t=u.length>=3?u[2].replace(/\./g,"").trim():"",n=e.length>=3?e[2].trim():"";let g=!1;f&&a?(f.length===1&&a.length>1||f.length>1&&a.length===1||f[0]===a[0])&&(g=f[0]===a[0]):!f&&!a&&(g=!0);let p=!1;if(t&&n?(t.length===1&&n.length>1||t.length>1&&n.length===1||t[0]===n[0])&&(p=t[0]===n[0]):(!t&&!n||!t&&n||t&&!n)&&(p=!0),g)return t||n?p:!0;if(f&&a&&f[0]===a[0]&&(t&&n&&t[0]===n[0]||!t&&!n))return!0;const N=y(r),c=y(l);return!!(N.length>8&&c.length>8&&(N.includes(c)||c.includes(N)))},I=s=>String(s??"").trim(),A=s=>(String(s).match(/\d+/)||[])[0]||null,k=(s,o)=>{if(!s||!o)return!1;const r=String(s).toLowerCase().trim(),l=String(o).toLowerCase().trim(),u=r.replace(/[^a-zа-я0-9]/g,""),e=l.replace(/[^a-zа-я0-9]/g,"");if(u===e||u.length>3&&e.length>3&&(u.includes(e)||e.includes(u)))return!0;const m=r.match(/\d+/g),i=l.match(/\d+/g);return m&&i?m.some(f=>i.includes(f)):!1},R=(s,o)=>{if(s===null||o===null)return null;let r=o-s;r<0&&(r+=1440);const l=Math.floor(r/60),u=r%60;return{hours:l,minutes:u,totalMinutes:r}},j=s=>{const[o,r,l]=s.split(".").map(Number);return l*1e4+r*100+o},w=s=>s?s.cleanTime||s.entryTime&&s.exitTime?"ok":s.entryTime&&!s.exitTime||!s.entryTime&&s.exitTime?"incomplete":"missing":"missing",F=(s,o)=>{if(!s||!s.data)return[];const{rawTables:r,lineTemplates:l,manualAssignments:u}=s.data;if(!(r!=null&&r.demand)||!Array.isArray(r.demand))return[];const e=r.demand,m=Array.isArray(e[0])?e[0]:[],i={};e.slice(1).forEach(a=>{if(!a)return;let t=a[11],n="";if(t instanceof Date)n=t.toLocaleDateString("ru-RU");else if(typeof t=="string"){const c=new Date(t);isNaN(c.getTime())?n=I(t):n=c.toLocaleDateString("ru-RU")}if(n!==o)return;const g=I(a[13]),p=I(a[14]),N=A(p);if(N){i[N]||(i[N]={id:N,name:p,type:g,activeLines:[]});for(let c=15;c<=26;c++){const T=I(m[c]);T&&(parseInt(a[c],10)||0)>0&&!i[N].activeLines.includes(T)&&i[N].activeLines.push(T)}}});const f=[];return Object.values(i).forEach(a=>{const t=[];a.activeLines.forEach(n=>{const g=Object.keys(l||{}).find(c=>k(n,c)),p=g?l[g]||[]:[],N=[];p.forEach(c=>{var b;const T=(b=c==null?void 0:c.roster)==null?void 0:b[a.id],h=T?T.split(/[,;\n/]+/).map(d=>d.trim()).filter(d=>d.length>1):[],M=Math.max(c.count||1,h.length);for(let d=0;d<M;d++){const v=`${o}_${a.id}_${n}_${c.role}_${d}`,C=h[d]||null,S=u==null?void 0:u[v];let x=C?"filled":"vacancy";S&&(x=S.type==="vacancy"?"vacancy":"manual"),N.push({status:x,roleTitle:c.role,slotId:v,currentWorkerName:C,assigned:S||(x==="filled"?{name:C}:null)})}}),N.length>0&&t.push({slots:N,displayName:g||n})}),t.length>0&&f.push({id:a.id,name:a.name,type:a.type,lineTasks:t})}),f},E=s=>{if(!s||typeof s!="object")return{byNorm:{},byRaw:{},dates:[]};const o={},r={},l=Object.keys(s).sort(),u=e=>{if(!e)return null;const m=String(e).match(/(\d{1,2}):(\d{2})/);return m?parseInt(m[1],10)*60+parseInt(m[2],10):null};return l.forEach(e=>{const m=s[e];!m||typeof m!="object"||(o[e]={},r[e]={},Object.values(m).forEach(i=>{if(!i||!i.rawName)return;const f=y(i.rawName),a=i.rawName,t={...i,entryTimeMinutes:u(i.entryTime),exitTimeMinutes:u(i.exitTime)};o[e][f]||(o[e][f]=t),r[e][a]=t}))}),{byNorm:o,byRaw:r,dates:l}},$=(s,o)=>{const r={};return Object.entries(s).forEach(([l,u])=>{r[l]={},u.forEach(e=>{e.lineTasks.forEach(m=>{m.slots.forEach(i=>{if((i.status==="filled"||i.status==="manual"||i.status==="reassigned")&&i.assigned){const f=i.assigned.name,a=y(f);o.has(a)?r[l][a]||(r[l][a]={shiftId:e.id,shiftName:e.name,lineName:m.displayName,role:i.roleTitle,isRv:i.assigned.type==="external"}):o.forEach((t,n)=>{O(f,t.name)&&!r[l][n]&&(r[l][n]={shiftId:e.id,shiftName:e.name,lineName:m.displayName,role:i.roleTitle,isRv:i.assigned.type==="external"})})}})})})}),r},z=({workerRegistry:s,factData:o,savedPlans:r,allEmployees:l})=>{const u=r==null?void 0:r.find(t=>t.type==="Operational"),e=new Map;if((s||[]).forEach(t=>{var g;if(!t||!t.name)return;const n=y(t.name);e.set(n,{name:t.name,role:t.role||"Не указано",department:((g=l==null?void 0:l[n])==null?void 0:g.department)||"",shiftsCount:0,rvCount:0,errorCount:0,hoursTotal:0,events:[]})}),o&&typeof o=="object"&&Object.keys(o).length>0&&Object.values(o).forEach(t=>{!t||typeof t!="object"||Object.values(t).forEach(n=>{var g;if(n&&n.rawName){const p=y(n.rawName);e.has(p)||e.set(p,{name:n.rawName,role:"Не указано",department:((g=l==null?void 0:l[p])==null?void 0:g.department)||"",shiftsCount:0,rvCount:0,errorCount:0,hoursTotal:0,events:[]})}})}),!(u!=null&&u.data)){if(o&&typeof o=="object"&&Object.keys(o).length>0){const t=E(o);e.forEach((n,g)=>{const p=[];let N=0,c=0;t.dates.forEach(T=>{var d,v;let h=(d=t.byNorm[T])==null?void 0:d[g];!h&&n.name&&(h=(v=t.byRaw[T])==null?void 0:v[n.name]);const M=w(h);M==="incomplete"&&N++;let b=null;h&&h.entryTimeMinutes!==null&&h.exitTimeMinutes!==null&&(b=R(h.entryTimeMinutes,h.exitTimeMinutes),b&&(c+=b.totalMinutes)),p.push({date:T,planInfo:null,factInfo:h||null,duration:b,status:M})}),n.errorCount=N,n.hoursTotal=c,n.events=p.sort((T,h)=>j(T.date)-j(h.date))})}return Array.from(e.values())}const m=u.data.scheduleDates||[],i={};m.forEach(t=>{i[t]=F(u,t)});const f=$(i,e),a=E(o);return e.forEach((t,n)=>{const g=[];let p=0,N=0,c=0,T=0;m.forEach(h=>{var S,x,L;const M=(S=f[h])==null?void 0:S[n];let b=!1;M&&(b=!0,M.isRv?N++:p++);let d=(x=a.byNorm[h])==null?void 0:x[n];!d&&t.name&&(d=(L=a.byRaw[h])==null?void 0:L[t.name]);const v=w(d);v==="incomplete"&&c++;let C=null;d&&d.entryTimeMinutes!==null&&d.exitTimeMinutes!==null&&(C=R(d.entryTimeMinutes,d.exitTimeMinutes),C&&(T+=C.totalMinutes)),g.push({date:h,planInfo:b?M:null,factInfo:d||null,duration:C,status:v})}),t.shiftsCount=p,t.rvCount=N,t.errorCount=c,t.hoursTotal=T,t.events=g.sort((h,M)=>j(h.date)-j(M.date))}),Array.from(e.values())};self.onmessage=s=>{const{requestId:o,payload:r}=s.data||{};if(!r)return;const{workerRegistry:l,factData:u,savedPlans:e,allEmployees:m}=r,i=z({workerRegistry:l,factData:u,savedPlans:e,allEmployees:m}),f=new Set;i.forEach(t=>{t.role&&t.role!=="Не указано"&&f.add(t.role)});const a=Array.from(f).sort();self.postMessage({requestId:o,result:{employeesWithStats:i,allRoles:a}})}})();
