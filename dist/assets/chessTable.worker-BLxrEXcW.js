(function(){"use strict";const _=u=>String(u??"").trim(),R=u=>(String(u).match(/\d+/)||[])[0]||null,x=u=>String(u).toLowerCase().replace(/ё/g,"е").replace(/[^a-zа-я]/g,""),z=(u,S)=>{if(!u||!S)return!1;const y=String(u).toLowerCase().trim(),r=String(S).toLowerCase().trim();if(x(y)===x(r))return!0;const i=y.split(/\s+/).filter(k=>k.length>0),h=r.split(/\s+/).filter(k=>k.length>0);if(i.length===0||h.length===0)return!1;const M=x(i[0]),B=x(h[0]);if(M!==B)return!1;if(i.length===1&&h.length===1)return!0;const c=i.length>=2?i[1].replace(/\./g,"").trim():"",o=h.length>=2?h[1].trim():"",l=i.length>=3?i[2].replace(/\./g,"").trim():"",p=h.length>=3?h[2].trim():"";let D=!1;c&&o?(c.length===1&&o.length>1||c.length>1&&o.length===1||c[0]===o[0])&&(D=c[0]===o[0]):!c&&!o&&(D=!0);let I=!1;if(l&&p?(l.length===1&&p.length>1||l.length>1&&p.length===1||l[0]===p[0])&&(I=l[0]===p[0]):(!l&&!p||!l&&p||l&&!p)&&(I=!0),D)return l||p?I:!0;if(c&&o&&c[0]===o[0]){if(l&&p&&l[0]===p[0])return!0;if(!l&&!p)return!0}const E=x(y),L=x(r);return!!(E.length>8&&L.length>8&&(E.includes(L)||L.includes(E)))},P=(u,S)=>{if(!u||!S)return!1;const y=String(u).toLowerCase().trim(),r=String(S).toLowerCase().trim(),i=y.replace(/[^a-zа-я0-9]/g,""),h=r.replace(/[^a-zа-я0-9]/g,"");if(i===h||i.length>3&&h.length>3&&(i.includes(h)||h.includes(i)))return!0;const M=y.match(/\d+/g),B=r.match(/\d+/g);return M&&B?M.some(c=>B.includes(c)):!1},H=(u,S,y)=>{if(!y||!y[u])return{available:!0};const r=y[u].status;if(!r)return{available:!0};const[i,h,M]=S.split(".").map(Number),B=new Date(M,h-1,i),c=r;if(c.permanent)return{available:!1,reason:c.raw,type:c.type};if(c.from&&c.to){B.setHours(0,0,0,0);const o=new Date(c.from);o.setHours(0,0,0,0);const l=new Date(c.to);if(l.setHours(0,0,0,0),B>=o&&B<=l)return{available:!1,reason:c.raw,type:c.type}}return{available:!0}},T=u=>{const S=String(u||"").trim().split(/\s+/)[0]||"";return x(S)};function V(u){const S=Array.isArray(u==null?void 0:u[0])?u[0]:[],y=new Map;return(u||[]).slice(1).forEach(r=>{let i=r==null?void 0:r[11],h="";if(i instanceof Date)h=i.toLocaleDateString("ru-RU");else if(typeof i=="string"){const l=new Date(i);isNaN(l.getTime())?h=_(i):h=l.toLocaleDateString("ru-RU")}if(!h||h.length<5)return;const M=_(r==null?void 0:r[13]),B=_(r==null?void 0:r[14]),c=R(B);if(!c)return;y.has(h)||y.set(h,{});const o=y.get(h);o[c]||(o[c]={id:c,name:B,type:M,activeLines:[]});for(let l=15;l<=26;l++){const p=_(S==null?void 0:S[l]);p&&(parseInt(r==null?void 0:r[l])||0)>0&&!o[c].activeLines.includes(p)&&o[c].activeLines.push(p)}}),{headers:S,brigadesByDate:y}}function q({targetDate:u,brigadesMap:S,lineTemplates:y,floaters:r,manualAssignments:i,workerRegistry:h,availabilityCache:M,autoReassignEnabled:B}){if(!S)return[];const c=o=>{const l=`${o}|${u}`;if(M.has(l))return M.get(l);const p=H(o,u,h);return M.set(l,p),p};return Object.values(S).map(o=>{const l=o.type?String(o.type).toLowerCase():"",p=[],D=[],I=new Map,E=new Map;Object.keys(y||{}).forEach(b=>{(y[b]||[]).forEach(d=>{var s;const e=(s=d==null?void 0:d.roster)==null?void 0:s[o.id];e&&String(e).split(/[,;\n/]+/).map(t=>t.trim()).filter(t=>t.length>1).forEach(t=>{const m=c(t),n={name:t,role:d.role,homeLine:b,id:`${t}_${o.id}`,isBusy:!1,isAvailable:m.available,statusReason:m.reason};D.push(n),I.set(n.id,n),E.set(`${x(t)}|${b}`,n)})})});const L=new Set;Object.keys(i||{}).forEach(b=>{if(b.startsWith(u)){const d=i[b];(d==null?void 0:d.type)!=="vacancy"&&L.add(d.originalId||d.id)}}),(o.activeLines||[]).forEach(b=>{const d=Object.keys(y||{}).find(t=>P(b,t)),e=d?y[d]:[],s=[];e.length>0&&e.forEach(t=>{var a,v;const m=(a=t==null?void 0:t.roster)==null?void 0:a[o.id],n=m?String(m).split(/[,;\n/]+/).map(g=>g.trim()).filter(g=>g.length>1):[],f=Math.max(t.count,n.length);for(let g=0;g<f;g++){const N=`${u}_${o.id}_${b}_${t.role}_${g}`,w=n[g]||null;let C="vacancy";w&&(C=c(w).available?"filled":"vacancy");const $=i==null?void 0:i[N];if($&&(C=$.type==="vacancy"?"vacancy":"manual"),C==="filled"&&w&&(c(w).available||(C="vacancy")),s.push({status:C,roleTitle:t.role,slotId:N,isManualVacancy:((v=i==null?void 0:i[N])==null?void 0:v.type)==="vacancy",currentWorkerName:w,assigned:$||(C==="filled"?{name:w}:null)}),$&&$.type!=="vacancy"&&$.type!=="floater"){const O=I.get($.originalId||$.id);O&&(O.isBusy=!0)}else if(!$&&C==="filled"&&w){const O=E.get(`${x(w)}|${d||""}`);O&&(O.isBusy=!0)}}}),p.push({slots:s,displayName:d||b})});const k=D.filter(b=>!b.isBusy&&b.isAvailable);B&&p.forEach(b=>{b.slots.forEach(d=>{if(d.status==="vacancy"&&!d.isManualVacancy&&k.length>0){let e=k.findIndex(s=>s.role===d.roleTitle);e===-1&&(e=k.findIndex(s=>{var m;const t=h==null?void 0:h[s.name];return t&&((m=t.competencies)==null?void 0:m.has)&&t.competencies.has(d.roleTitle)})),e>=0&&(d.status="reassigned",d.assigned=k[e],k[e].isBusy=!0,k.splice(e,1))}})});const W=(l.includes("день")?[...(r==null?void 0:r.day)||[]]:[...(r==null?void 0:r.night)||[]]).filter(b=>!L.has(b.id)),A=p.reduce((b,d)=>b+d.slots.length,0),F=p.reduce((b,d)=>b+d.slots.filter(e=>e.status!=="vacancy"&&e.status!=="unknown").length,0);return{id:o.id,name:o.name,type:o.type,lineTasks:p,unassignedPeople:D.filter(b=>!b.isBusy),floaters:W,totalRequired:A,filledSlots:F}})}function U(u){const{scheduleDates:S,demand:y,lineTemplates:r,floaters:i,manualAssignments:h,workerRegistry:M,factData:B,autoReassignEnabled:c}=u,o=Array.isArray(S)?S:[];if(!y||o.length===0)return null;const l={};Object.entries(M||{}).forEach(([e,s])=>{l[e]={...s,competencies:new Set((s==null?void 0:s.competencies)||[])}});const p=V(y),D=new Map,I=new Map;o.forEach(e=>{I.set(e,q({targetDate:e,brigadesMap:p.brigadesByDate.get(e),lineTemplates:r,floaters:i,manualAssignments:h,workerRegistry:l,availabilityCache:D,autoReassignEnabled:c}))});const E=new Map;Object.keys(r||{}).forEach(e=>{(r[e]||[]).forEach(s=>{const t=(s==null?void 0:s.roster)||{};Object.entries(t).forEach(([m,n])=>{n&&String(n).split(/[,;\n/]+/).map(f=>f.trim()).filter(f=>f.length>1).forEach(f=>{E.has(f)||E.set(f,{name:f,role:s.role,homeLine:e,homeBrigades:new Set,category:"staff",sortShift:99});const a=E.get(f);a.homeBrigades.add(m),a.sortShift=Math.min(a.sortShift,parseInt(m)||99)})})})}),((i==null?void 0:i.day)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Д",homeBrigades:new Set,category:"floater_day",sortShift:100}))}),((i==null?void 0:i.night)||[]).forEach(e=>{e!=null&&e.name&&(E.has(e.name)||E.set(e.name,{name:e.name,role:"Подсобник",homeLine:"Резерв Н",homeBrigades:new Set,category:"floater_night",sortShift:101}))});const L=Array.from(E.values()).sort((e,s)=>(e.category==="staff"?e.sortShift-s.sortShift:10)||e.name.localeCompare(s.name)),k=new Map,j=new Map;L.forEach(e=>{const s=x(e.name);k.set(s,e);const t=T(e.name);j.has(t)||j.set(t,[]),j.get(t).push(e)});const W=new Map,A=new Map;B&&Object.entries(B).forEach(([e,s])=>{const t=new Map,m=new Map;Object.values(s||{}).forEach(n=>{if(!n)return;const f=n.rawName||"",a=x(f);a&&t.set(a,n);const v=T(f);m.has(v)||m.set(v,[]),m.get(v).push(n)}),W.set(e,t),A.set(e,m)});const F=(e,s)=>{const t=W.get(e);if(!t)return null;const m=x(s),n=t.get(m);if(n)return n;const f=T(s),a=A.get(e),v=(a==null?void 0:a.get(f))||[];for(const g of v)if(g!=null&&g.rawName&&z(s,g.rawName))return g;return null};if(B){const e=new Map;o.forEach(s=>{const t=A.get(s);t&&t.forEach(m=>{m.forEach(n=>{if(!(n!=null&&n.rawName)||!n.cleanTime)return;const f=x(n.rawName);if(k.has(f))return;const a=T(n.rawName),v=j.get(a)||[];let g=!1;for(const N of v)if(z(N.name,n.rawName)){g=!0;break}if(!g&&!e.has(f)){const N=(M==null?void 0:M[n.rawName])||null;e.set(f,{name:n.rawName,role:(N==null?void 0:N.role)||"Неизвестно",homeLine:"Вне плана",homeBrigades:new Set,category:"unexpected",sortShift:102,cells:{}})}})})}),e.size>0&&(e.forEach(s=>L.push(s)),L.sort((s,t)=>(s.category==="staff"?s.sortShift-t.sortShift:10)||s.name.localeCompare(t.name)))}L.forEach(e=>{e.cells={}});const b=(e,s)=>{const t=`${e}|${s}`;if(D.has(t))return D.get(t);const m=H(e,s,l);return D.set(t,m),m};o.forEach(e=>{const s=I.get(e)||[],t=new Map,m=new Map;s.forEach(n=>{const a=String(n.type||"").toLowerCase().includes("ночь")?"Н":"Д";n.lineTasks.forEach(v=>{v.slots.forEach(g=>{if((g.status==="filled"||g.status==="manual"||g.status==="reassigned")&&g.assigned){const N=g.assigned.name;if(g.assigned.type==="external")t.set(N,{code:"РВ",brigadeId:n.id,isRv:!0});else{const w=t.get(N),C=w&&w.code!==a&&!w.isRv?"Д/Н":a;t.set(N,{code:C,brigadeId:n.id})}}})}),n.unassignedPeople.forEach(v=>{v.isAvailable&&m.set(v.name,n.id)}),n.floaters.forEach(v=>m.set(v.name,n.id))}),L.forEach(n=>{let f="",a="bg-white",v=null,g=null;const N=b(n.name,e);if(!N.available)N.type==="vacation"?(f="О",a="bg-emerald-50 text-emerald-700 border-emerald-200"):N.type==="sick"?(f="Б",a="bg-amber-50 text-amber-700 border-amber-200"):N.type==="fired"&&(f="У",a="bg-slate-200 text-slate-500");else if(t.has(n.name)){const w=t.get(n.name);f=w.code,v=w.brigadeId,f==="Д"?a="bg-green-100 text-green-800 border-green-200 font-bold":f==="Н"?a="bg-blue-100 text-blue-800 border-blue-200 font-bold":f==="Д/Н"?a="bg-teal-100 text-teal-800 border-teal-200 font-bold":f==="РВ"&&(a="bg-orange-100 text-orange-700 border-orange-200 font-bold");const C=F(e,n.name);C&&(C.cleanTime?(g="ok",a.includes("ring-")||(a=a.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-green-500")):(g="missing",a.includes("ring-")||(a=a.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")))}else if(m.has(n.name)){f="—",a="bg-yellow-100 text-yellow-800 border-yellow-200 font-bold",v=m.get(n.name);const w=F(e,n.name);w&&(w.cleanTime?g="unassigned":(g="missing",a.includes("ring-")||(a=a.replace(/border-\\w+-\\d+/g,"").trim()+" ring-2 ring-red-500")))}else{const w=F(e,n.name);w&&w.cleanTime&&(g="unexpected",f="!",a="bg-orange-50 text-orange-700 border-orange-200 font-bold")}n.cells[e]={text:f,color:a,brigadeId:v,verificationStatus:g}})});const d=L.map(e=>({...e,homeBrigades:Array.from(e.homeBrigades||[])}));return{dates:o,workers:d}}self.onmessage=u=>{const{requestId:S,payload:y}=u.data||{};try{const r=U(y);self.postMessage({requestId:S,result:r})}catch(r){self.postMessage({requestId:S,error:(r==null?void 0:r.message)||String(r)})}}})();
